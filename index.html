<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weather Data Display</title>

  <!-- Link to Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Link to some basic styles -->
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f7f7f7;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }

    th, td {
      padding: 12px;
      text-align: left;
    }

    th {
      background-color: #4CAF50;
      color: white;
    }

    td {
      background-color: #f2f2f2;
    }

    td:hover {
      background-color: #ddd;
    }

    .chart-container {
      width: 100vw; /* Full screen width */
      max-width: 95vw; /* Prevents overflowing on large screens */
      height: 50vh; /* Adjust height dynamically */
      max-height: 700px; /* Prevents excessive height */
      min-height: 300px; /* Ensures visibility on small screens */
      margin-top: 40px; 
    }

    @media (max-width: 600px) {
      table, th, td {
        font-size: 12px;
      }

      .chart-container {
        height: 40vh; /* Reduce height for small screens */
      }
    }

  </style>
</head>
<body>
  <h1>Weather Data</h1>
  
  <!-- Chart container for displaying graph (moved to the top) -->
  <div class="chart-container">
    <canvas id="weatherChart"></canvas>
  </div>

  <!-- Table to display the weather data -->
  <table id="weather-table">
    <thead>
      <tr>
        <th>Time</th>
        <th>(째C)</th>
        <th>FL</th>
        <th>(m/s)</th>
        <th>NWSE</th>
        <th>Wind</th>
        <th>(%)</th>
      </tr>
    </thead>
    <tbody id="weather-data"></tbody>
  </table>

<script>
  // Fetch the weather data from the GitHub repository
   // Fetch the weather data from the GitHub repository
  fetch('https://raw.githubusercontent.com/Arwond/weather-data-pretty/main/data/weather.json')
    .then(response => response.json())
    .then(data => {
      // Reverse the data by Timestamp to show most recent first
      data["Weather Data"].forEach(entry => {
        entry.Timestamp = formatTimestamp(entry.Timestamp);
      });
      data["Weather Data"].reverse();
      
      // Call function to display the data in the table
      displayWeatherData(data["Weather Data"]);
      
      // Call function to generate the chart
      generateChart(data["Weather Data"]);
    })
    .catch(error => console.log('Error fetching data:', error));

  // Function to display weather data in the table
  function displayWeatherData(data) {
    const tableBody = document.getElementById('weather-data');
    tableBody.innerHTML = ''; // Clear any existing table rows

    data.forEach(entry => {
      const row = document.createElement('tr');

      const timestamp = document.createElement('td');
      
      if (entry.Timestamp === null) {
        console.error("Invalid Timestamp:", entry.Timestamp);
        return; // Skip this entry if timestamp cannot be corrected
      }
      
      timestamp.textContent = entry.Timestamp; 
      row.appendChild(timestamp);

      const temperature = document.createElement('td');
      temperature.textContent = entry["Temperature (째C)"];
      row.appendChild(temperature);

      const feelslike = document.createElement('td');
      feelslike.textContent = entry["FeelsLike"];
      row.appendChild(feelslike);

      const windSpeed = document.createElement('td');
      windSpeed.textContent = entry["Wind Speed (m/s)"];
      row.appendChild(windSpeed);

      const windDirection = document.createElement('td');
      windDirection.textContent = entry["Wind Direction"];
      row.appendChild(windDirection);

      const wind = document.createElement('td');
      wind.textContent = entry["Wind"];
      row.appendChild(wind);

      const humidity = document.createElement('td');
      humidity.textContent = entry["Humidity (%)"];
      row.appendChild(humidity);
      


      tableBody.appendChild(row);
    });
  }


// Function to generate the chart
function generateChart(data) {
    const ctx = document.getElementById('weatherChart').getContext('2d');
    
    // Prepare data for chart
    const labels = [];
    const temperatureData = [];
    const windSpeedData = [];

    // Get current time
    const now = new Date();

	
	
    // Filter data for the last 48 hours
    const filteredData = data.filter(entry => {
        if (entry.Timestamp === null) {
            console.error("Invalid Timestamp:", entry.Timestamp);
            return false; // Skip invalid timestamps
        }
        
        // Convert formatted date back to Date object for comparison
        const entryDate = new Date(entry.Timestamp);
        return (now - entryDate) <= (48 * 60 * 60 * 1000); // Check if within last 48 hours
    });
	
    filteredData.forEach(entry => {        
        if (entry.Timestamp === null) {
            console.error("Invalid Timestamp:", entry.Timestamp);
            return; // Skip this entry if timestamp cannot be corrected
        }
        
        labels.push(entry.Timestamp);
        temperatureData.push(parseFloat(entry["Temperature (째C)"]));
        windSpeedData.push(parseFloat(entry["Wind Speed (m/s)"]));
    });

    // Create chart
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Temperature (째C)',
                    data: temperatureData,
                    borderColor: 'red',
                    fill: false,
                    borderWidth: 0.5 // Thicker line for temperature
                },
                {
                    label: 'Wind Speed (m/s)',
                    data: windSpeedData,
                    borderColor: 'blue',
                    fill: false,
                    borderWidth: 0.5 // Thicker line for wind speed
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
            x: { 
              ticks: { 
                autoSkip: true, 
                maxTicksLimit: 10 
              }
            }
          }

        }
    });
}


// Function to format timestamps and convert them to yyyy-mm-dd HH:mm format
function formatTimestamp(timestamp) {
	try {
	  let dateObj;
		
	  // Check for "yyyy-dd-mmTHH:mm:ss.000Z" format
	  if (timestamp.includes("T")) {
	    let parts = timestamp.split(/[-T:.Z]/); // Split into components
		
	    if (parts.length !== 8) return null; // Must have year, day, month, hour, minute

	    const year = parseInt(parts[0]);
	    const month = parseInt(parts[1]);
	    const day = parseInt(parts[2]);
	    const hours = parseInt(parts[3]);
	    const minutes = parseInt(parts[4]);

	    dateObj = new Date(year, month - 1, day, hours, minutes); // Month is zero-based in JS Date

	  } else if (timestamp.includes(" ")) { // Check for "dd-MM-yyyy HH:mm" format
	    let [datePart, timePart] = timestamp.split(" ");
	    let [day, month, year] = datePart.split("-").map(Number);
	    let [hours, minutes] = timePart.split(":").map(Number);

	    dateObj = new Date(year, month - 1, day, hours, minutes); // Month is zero-based in JS Date

	  } else {
	    return null; // Invalid format
	  }

	  // Format date as yyyy-mm-dd HH:mm
	  let formattedDate = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')} ${String(dateObj.getHours()).padStart(2, '0')}:${String(dateObj.getMinutes()).padStart(2, '0')}`;

	  return formattedDate; // Return formatted date string
	} catch (error) {
	  console.error("Error formatting timestamp:", error);
	  return null;
	}
}

</script>

</body>
</html>
